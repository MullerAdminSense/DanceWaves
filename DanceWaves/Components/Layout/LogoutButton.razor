@using Microsoft.AspNetCore.Components.Authorization
@using System.Linq
@using System
@using System.Security.Claims
@rendermode InteractiveServer
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject DanceWaves.Application.Ports.IAuthenticationPort AuthenticationPort
@inject ILogger<LogoutButton> Logger
@inject IJSRuntime JSRuntime

<button class="btn btn-danger btn-sm" @onclick="HandleLogout" type="button" disabled="@IsLoggingOut">
    @if (IsLoggingOut)
    {
        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
        <span>Logging out...</span>
    }
    else
    {
        <span>Logout</span>
    }
</button>

@code {
    private bool IsLoggingOut { get; set; } = false;

    private async Task HandleLogout()
    {
        if (IsLoggingOut) return;
        
        IsLoggingOut = true;
        StateHasChanged();
        
        try
        {
            // Fetch the userId BEFORE clearing auth state
            string? userId = null;
            try
            {
                var authState = await AuthStateProvider.GetAuthenticationStateAsync();
                userId = authState.User?.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Could not get userId during logout, continuing anyway");
            }

            // Clear auth state â€” critical for logout to work
            if (AuthStateProvider is DanceWaves.Infrastructure.Security.CustomAuthenticationStateProvider customProvider)
            {
                try
                {
                    await customProvider.MarkUserAsLoggedOut();
                    Logger.LogInformation("Authentication state cleared successfully");
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error clearing authentication state during logout: {Error}", ex.Message);
                }
            }

            // Invoke adapter logout (for DB logging, etc.)
            if (!string.IsNullOrWhiteSpace(userId))
            {
                try
                {
                    await AuthenticationPort.LogoutAsync(userId);
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Error calling LogoutAsync from adapter: {Error}", ex.Message);
                }
            }

            // Limpa o localStorage diretamente via JavaScript para garantir
            try
            {
                await JSRuntime.InvokeVoidAsync("localStorage.removeItem", "accessToken");
            }
            catch (Exception ex)
            {
                Logger.LogWarning(ex, "Could not clear localStorage via JS: {Error}", ex.Message);
            }

            // Aguarda um pouco para garantir que o estado seja atualizado
            await Task.Delay(200);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Unexpected error during logout process: {Error}", ex.Message);
        }
        finally
        {
            IsLoggingOut = false;
            
            // ALWAYS redirect to the login page
            try
            {
                // Try Blazor navigation first
                Navigation.NavigateTo("/login", forceLoad: true);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error navigating to login page with Blazor: {Error}", ex.Message);
                // Fallback to JS redirect if Blazor navigation fails
                try
                {
                    await JSRuntime.InvokeVoidAsync("logoutRedirect", "/login");
                }
                catch (Exception jsEx)
                {
                    Logger.LogError(jsEx, "Error navigating using JavaScript: {Error}", jsEx.Message);
                    // Se tudo falhar, tenta redirecionar diretamente via window.location
                    try
                    {
                        await JSRuntime.InvokeVoidAsync("eval", "window.location.href = '/login'");
                    }
                    catch
                    {
                        Logger.LogError("All logout navigation attempts failed - manual navigation required");
                    }
                }
            }
        }
    }
}

