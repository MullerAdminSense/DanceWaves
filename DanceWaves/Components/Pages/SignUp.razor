    
@using System.Security.Claims
@inject AuthenticationStateProvider AuthenticationStateProvider
@page "/signup"
@using DanceWaves.Application.Dtos
    
@using DanceWaves.Application.UseCases
@using DanceWaves.Application.Ports
@using DanceWaves.Models
@inject IAuthenticationPort AuthenticationPort
@inject NavigationManager Navigation
@inject ILogger<SignUp> Logger
@rendermode InteractiveServer

<div class="container-fluid mt-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">ðŸ“‹ Sign Up</h3>
                    <p class="mb-0 small">Create your DanceWaves account</p>
                </div>

                <div class="card-body p-5">
                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="alert alert-danger">@ErrorMessage</div>
                    }
                    @if (!string.IsNullOrEmpty(SuccessMessage))
                    {
                        <div class="alert alert-success">@SuccessMessage</div>
                    }
                    <form @onsubmit="HandleRegister">
                            
                            <div class="mb-3">
                                <label for="firstName" class="form-label">First Name *</label>
                                <input type="text" class="form-control" id="firstName" placeholder="Enter your first name" @bind="User.FirstName" required />
                            </div>
                            <div class="mb-3">
                                <label for="lastName" class="form-label">Last Name *</label>
                                <input type="text" class="form-control" id="lastName" placeholder="Enter your last name" @bind="User.LastName" required />
                            </div>
                            <div class="mb-3">
                                <label for="address" class="form-label">Address</label>
                                <input type="text" class="form-control" id="address" @bind="User.Address" />
                            </div>
                            <div class="mb-3">
                                <label for="city" class="form-label">City</label>
                                <input type="text" class="form-control" id="city" @bind="User.City" />
                            </div>
                            <div class="mb-3">
                                <label for="zip" class="form-label">Zip</label>
                                <input type="text" class="form-control" id="zip" @bind="User.Zip" />
                            </div>
                            <div class="mb-3">
                                <label for="province" class="form-label">Province</label>
                                <input type="text" class="form-control" id="province" @bind="User.Province" />
                            </div>
                            <div class="mb-3">
                                <label for="country" class="form-label">Country</label>
                                <select class="form-select" id="country" @bind="User.CountryId">
                                    <option value="">Select a country</option>
                                    @foreach (var country in Countries)
                                    {
                                        <option value="@country.Id">@country.Name</option>
                                    }
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">Email Address *</label>
                                <input type="email" class="form-control" id="email" placeholder="Enter your email" @bind="User.Email" required />
                            </div>
                            <div class="mb-3">
                                <label for="danceSchool" class="form-label">Dance School</label>
                                <select class="form-select" id="danceSchool" @bind-value="User.DanceSchoolId" @bind-value:event="onchange">
                                    <option value="">Select a dance school</option>
                                    @foreach (var school in DanceSchools)
                                    {
                                        <option value="@school.Id">@school.LegalName</option>
                                    }
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="phone" class="form-label">Phone Number</label>
                                <input type="text" class="form-control" id="phone" placeholder="Enter your phone number" @bind="User.Phone" />
                            </div>
                            <div class="mb-3">
                                <label for="franchise" class="form-label">Default Franchise</label>
                                <select class="form-select" id="franchise" @bind="User.DefaultFranchiseId">
                                    <option value="">Select a franchise</option>
                                    @foreach (var franchise in FilteredFranchises)
                                    {
                                        <option value="@franchise.Id">@franchise.LegalName</option>
                                    }
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="ageGroup" class="form-label">Age Group</label>
                                <select class="form-select" id="ageGroup" @bind="User.AgeGroupId">
                                    <option value="">Select an age group</option>
                                    @foreach (var ageGroup in AgeGroups)
                                    {
                                        <option value="@ageGroup.Id">@ageGroup.Name</option>
                                    }
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="rolePermission" class="form-label">Role Permission</label>
                                <input type="text" class="form-control" id="rolePermission" value="@RoleName" readonly disabled />
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-lg w-100" disabled="@IsLoading">
                                @(IsLoading ? "Creating..." : "Create Account")
                            </button>
                            <div class="text-center mt-3">
                                <p class="text-muted">Already have an account? <a href="/login">Sign In</a></p>
                            </div>
                        </form>
                    
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private UserDto User { get; set; } = new();
    private List<(int Id, string Name)> Countries { get; set; } = new();
    private List<DanceSchool> DanceSchools { get; set; } = new();
    private List<Franchise> FilteredFranchises { get; set; } = new();
    private List<AgeGroup> AgeGroups { get; set; } = new();
    private List<UserRolePermission> RolePermissions { get; set; } = new List<UserRolePermission>();
    private int? SelectedDanceSchoolId { get; set; }
    private int? SelectedFranchiseId { get; set; }
    private int? SelectedCountryId { get; set; }
    private int? SelectedAgeGroupId { get; set; }
    private string? ErrorMessage { get; set; }
    private string? SuccessMessage { get; set; }
    private bool IsLoading { get; set; }
    private bool ShowPassword { get; set; }
    private bool ShowConfirmPassword { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            RolePermissions = await GetAllRolePermissionsAsync();
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userPrincipal = authState.User;
            string? userId = userPrincipal.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            UserDto? loadedUser = null;
            if (!string.IsNullOrEmpty(userId))
            {
                loadedUser = await AuthenticationPort.GetCurrentUserAsync(userId);
            }
            if (loadedUser != null)
            {
                User = loadedUser;
            }
            else
            {
                User = new UserDto();
                User.RolePermissionId = RolePermissions.FirstOrDefault(r => r.Name == "User")?.Id ?? 3;
            }
            Countries = new List<(int, string)>
            {
                ((int)CountryId.USA, "United States"),
                ((int)CountryId.Netherlands, "Netherlands"),
                ((int)CountryId.France, "France"),
                ((int)CountryId.Germany, "Germany")
            };
            DanceSchools = await AuthenticationPort.GetAllDanceSchoolsAsync();
            
            if (User.DanceSchoolId != null)
            {
                SelectedDanceSchoolId = User.DanceSchoolId;
                await LoadFranchisesForSelectedSchool();
            }
            if (User.CountryId != null)
            {
                SelectedCountryId = User.CountryId;
            }
            if (User.AgeGroupId != null)
            {
                SelectedAgeGroupId = User.AgeGroupId;
            }
            
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading profile data: {ex.Message}";
            Logger.LogError(ex, "Error loading profile data in SignUp");
        }
    }
    private async Task<List<UserRolePermission>> GetAllRolePermissionsAsync()
    {
        
        return await AuthenticationPort.GetAllRolePermissionsAsync();
    }

    private async Task LoadFranchisesForSelectedSchool()
    {
        if (SelectedDanceSchoolId != null)
        {
            FilteredFranchises = await AuthenticationPort.GetFranchisesByDanceSchoolAsync(SelectedDanceSchoolId.Value);
        }
        else
        {
            FilteredFranchises = new List<Franchise>();
        }
    }

    private async Task OnDanceSchoolChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var schoolId))
        {
            SelectedDanceSchoolId = schoolId;
            User.DanceSchoolId = schoolId;
            await LoadFranchisesForSelectedSchool();
            StateHasChanged();
        }
    }

    private string RoleName
    {
        get
        {
            if (User.RolePermissionId == 0)
                return string.Empty;
            var role = RolePermissions.FirstOrDefault(r => r.Id == User.RolePermissionId);
            if (role != null && !string.IsNullOrWhiteSpace(role.Name))
                return role.Name;
            
            role = RolePermissions.FirstOrDefault(r => r.Name?.Equals("User", StringComparison.OrdinalIgnoreCase) == true);
            if (role != null)
                return role.Name;
            return $"Role {User.RolePermissionId}";
        }
    }

    private async Task HandleRegister()
    {
        ErrorMessage = null;
        SuccessMessage = null;
        IsLoading = true;
        try
        {
            var response = await AuthenticationPort.UpdateProfileAsync(User.Id.ToString(), User);
            if (response.IsSuccess)
            {
                SuccessMessage = "Account created successfully! Redirecting to login...";
                await Task.Delay(2000);
                Navigation.NavigateTo("/login");
            }
            else
            {
                ErrorMessage = response.Message ?? "Registration failed. Please try again.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"An error occurred: {ex.Message}";
            Logger.LogError(ex, "Erro ao registrar/atualizar perfil no SignUp");
        }
        finally
        {
            IsLoading = false;
        }
    }
}
