@page "/signup"
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using DanceWaves.Application.Dtos
@using DanceWaves.Application.Ports
@using DanceWaves.Models
@using CountryEnum = DanceWaves.Models.CountryId
@inject IUserPersistencePort UserPort
@inject IAuthenticationPort AuthenticationPort
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject ILogger<SignUp> Logger
@rendermode InteractiveServer

<div class="container-fluid mt-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0">@(IsEditMode ? "‚úèÔ∏è Edit Profile" : "üìã Sign Up")</h3>
                            <p class="mb-0 small">@(IsEditMode ? "Update your personal information" : "Create your DanceWaves account")</p>
                        </div>
                    </div>
                </div>

                <div class="card-body p-5">
                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="alert alert-danger alert-dismissible fade show">
                            @ErrorMessage
                            <button type="button" class="btn-close" @onclick="@(() => ErrorMessage = null)"></button>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(SuccessMessage))
                    {
                        <div class="alert alert-success alert-dismissible fade show">
                            @SuccessMessage
                            <button type="button" class="btn-close" @onclick="@(() => SuccessMessage = null)"></button>
                        </div>
                    }
                    
                    <form @onsubmit="HandleSubmit" @onsubmit:preventDefault="true">
                        <div class="mb-3">
                            <label for="firstName" class="form-label">First Name *</label>
                            <input type="text" class="form-control" id="firstName" @bind="FirstName" required />
                        </div>
                        
                        <div class="mb-3">
                            <label for="lastName" class="form-label">Last Name *</label>
                            <input type="text" class="form-control" id="lastName" @bind="LastName" required />
                        </div>
                        
                        <div class="mb-3">
                            <label for="email" class="form-label">Email Address *</label>
                            <input type="email" class="form-control" id="email" @bind="Email" required />
                        </div>
                        
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone Number</label>
                            <input type="text" class="form-control" id="phone" @bind="Phone" />
                        </div>
                        
                        <div class="mb-3">
                            <label for="address" class="form-label">Address</label>
                            <input type="text" class="form-control" id="address" @bind="Address" />
                        </div>
                        
                        <div class="mb-3">
                            <label for="city" class="form-label">City</label>
                            <input type="text" class="form-control" id="city" @bind="City" />
                        </div>
                        
                        <div class="mb-3">
                            <label for="zip" class="form-label">Zip</label>
                            <input type="text" class="form-control" id="zip" @bind="Zip" />
                        </div>
                        
                        <div class="mb-3">
                            <label for="province" class="form-label">Province</label>
                            <input type="text" class="form-control" id="province" @bind="Province" />
                        </div>
                        
                        <div class="mb-3">
                            <label for="country" class="form-label">Country</label>
                            <select class="form-select" id="country" @bind="SelectedCountryId">
                                <option value="0">Select a country</option>
                                @foreach (var country in Countries)
                                {
                                    <option value="@country.Id">@country.Name</option>
                                }
                            </select>
                        </div>
                        
                        @if (IsEditMode)
                        {
                            <div class="mb-3">
                                <label for="danceSchool" class="form-label">Dance School</label>
                                <input type="text" class="form-control" id="danceSchool" value="@DanceSchoolName" readonly disabled />
                            </div>
                            
                            <div class="mb-3">
                                <label for="franchise" class="form-label">Default Franchise</label>
                                <input type="text" class="form-control" id="franchise" value="@FranchiseName" readonly disabled />
                            </div>
                            
                            <div class="mb-3">
                                <label for="ageGroup" class="form-label">Age Group</label>
                                <input type="text" class="form-control" id="ageGroup" value="@AgeGroupName" readonly disabled />
                            </div>
                            
                            <div class="mb-3">
                                <label for="rolePermission" class="form-label">Role Permission</label>
                                <input type="text" class="form-control" id="rolePermission" value="@RolePermissionName" readonly disabled />
                            </div>
                        }
                        
                        @if (!IsEditMode)
                        {
                            <div class="mb-3">
                                <label for="password" class="form-label">Password *</label>
                                <div class="input-group">
                                    <input type="@(ShowPassword ? "text" : "password")" class="form-control" id="password" @bind="Password" required />
                                    <button class="btn btn-outline-secondary" type="button" @onclick="@(() => ShowPassword = !ShowPassword)">
                                        <i class="bi bi-eye@(ShowPassword ? "-slash" : "")"></i>
                                    </button>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="mb-3">
                                <label for="password" class="form-label">Password (leave blank to keep current)</label>
                                <div class="input-group">
                                    <input type="@(ShowPassword ? "text" : "password")" class="form-control" id="password" @bind="Password" />
                                    <button class="btn btn-outline-secondary" type="button" @onclick="@(() => ShowPassword = !ShowPassword)">
                                        <i class="bi bi-eye@(ShowPassword ? "-slash" : "")"></i>
                                    </button>
                                </div>
                                <small class="text-muted">Leave blank to keep your current password</small>
                            </div>
                        }
                        
                        <button type="submit" class="btn btn-primary btn-lg w-100" disabled="@IsLoading">
                            @if (IsLoading)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                @(IsEditMode ? "Updating..." : "Creating Account...")
                            }
                            else
                            {
                                @(IsEditMode ? "Update Profile" : "Create Account")
                            }
                        </button>
                        
                        @if (!IsEditMode)
                        {
                            <div class="text-center mt-3">
                                <p class="text-muted">Already have an account? <a href="/login">Sign In</a></p>
                            </div>
                        }
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string? FirstName { get; set; }
    private string? LastName { get; set; }
    private string? Email { get; set; }
    private string? Phone { get; set; }
    private string? Address { get; set; }
    private string? City { get; set; }
    private string? Zip { get; set; }
    private string? Province { get; set; }
    private int SelectedCountryId { get; set; }
    private string? Password { get; set; }
    
    private string DanceSchoolName { get; set; } = "-";
    private string FranchiseName { get; set; } = "-";
    private string AgeGroupName { get; set; } = "-";
    private string RolePermissionName { get; set; } = "-";
    
    private List<(int Id, string Name)> Countries { get; set; } = new();
    private string? ErrorMessage { get; set; }
    private string? SuccessMessage { get; set; }
    private bool IsLoading { get; set; }
    private bool ShowPassword { get; set; }
    private bool IsEditMode { get; set; }
    private int? CurrentUserId { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Countries = new List<(int, string)>
            {
                ((int)CountryEnum.USA, "United States"),
                ((int)CountryEnum.Netherlands, "Netherlands"),
                ((int)CountryEnum.France, "France"),
                ((int)CountryEnum.Germany, "Germany")
            };

            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            
            if (!string.IsNullOrEmpty(userIdClaim) && int.TryParse(userIdClaim, out var userId))
            {
                CurrentUserId = userId;
                IsEditMode = true;
                await LoadUserProfile(userId);
            }
            else
            {
                IsEditMode = false;
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading profile: {ex.Message}";
            Logger.LogError(ex, "Error loading profile in SignUp");
        }
    }

    private async Task LoadUserProfile(int userId)
    {
        try
        {
            var user = await UserPort.GetByIdAsync(userId);
            if (user != null)
            {
                FirstName = user.FirstName;
                LastName = user.LastName;
                Email = user.Email;
                Phone = user.Phone;
                Address = user.Address;
                City = user.City;
                Zip = user.Zip;
                Province = user.Province;
                SelectedCountryId = user.CountryId;
                
                // Carregar dados relacionados para exibi√ß√£o (readonly)
                await LoadRelatedData(user);
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading user data: {ex.Message}";
            Logger.LogError(ex, "Error loading user {UserId}", userId);
        }
    }

    private async Task LoadRelatedData(User user)
    {
        try
        {
            // Dance School
            if (user.DanceSchoolId.HasValue)
            {
                var danceSchools = await AuthenticationPort.GetAllDanceSchoolsAsync();
                var danceSchool = danceSchools.FirstOrDefault(ds => ds.Id == user.DanceSchoolId.Value);
                DanceSchoolName = danceSchool?.LegalName ?? "-";
            }
            
            // Franchise
            if (user.DefaultFranchiseId.HasValue)
            {
                var franchises = await AuthenticationPort.GetAllFranchisesAsync();
                var franchise = franchises.FirstOrDefault(f => f.Id == user.DefaultFranchiseId.Value);
                FranchiseName = franchise?.LegalName ?? "-";
            }
            
            // Age Group
            if (user.AgeGroupId.HasValue)
            {
                var ageGroups = await AuthenticationPort.GetAllAgeGroupsAsync();
                var ageGroup = ageGroups.FirstOrDefault(ag => ag.Id == user.AgeGroupId.Value);
                AgeGroupName = ageGroup?.Name ?? "-";
            }
            
            // Role Permission
            var rolePermissions = await AuthenticationPort.GetAllRolePermissionsAsync();
            var rolePermission = rolePermissions.FirstOrDefault(rp => rp.Id == user.RolePermissionId);
            RolePermissionName = rolePermission?.Name ?? "-";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading related data for user {UserId}", user.Id);
        }
    }

    private async Task HandleSubmit()
    {
        ErrorMessage = null;
        SuccessMessage = null;
        IsLoading = true;

        try
        {
            if (IsEditMode && CurrentUserId.HasValue)
            {
                await UpdateProfile();
            }
            else
            {
                await CreateAccount();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"An error occurred: {ex.Message}";
            Logger.LogError(ex, "Error in HandleSubmit");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task UpdateProfile()
    {
        try
        {
            var user = await UserPort.GetByIdAsync(CurrentUserId!.Value);
            if (user == null)
            {
                ErrorMessage = "User not found.";
                return;
            }

            user.FirstName = FirstName;
            user.LastName = LastName;
            user.Email = Email ?? string.Empty;
            user.Phone = Phone;
            user.Address = Address;
            user.City = City;
            user.Zip = Zip;
            user.Province = Province;
            user.CountryId = SelectedCountryId;
            
            if (!string.IsNullOrWhiteSpace(Password))
            {
                user.Password = Password;
            }

            await UserPort.UpdateAsync(user);
            SuccessMessage = "Profile updated successfully!";
            Password = null;
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error updating profile: {ex.Message}";
            Logger.LogError(ex, "Error updating user {UserId}", CurrentUserId);
        }
    }

    private async Task CreateAccount()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(Email) || string.IsNullOrWhiteSpace(Password))
            {
                ErrorMessage = "Email and Password are required.";
                return;
            }

            var registerRequest = new RegisterRequest
            {
                FirstName = FirstName ?? string.Empty,
                LastName = LastName ?? string.Empty,
                Email = Email,
                Password = Password,
                ConfirmPassword = Password,
                PhoneNumber = Phone,
                AcceptTerms = true
            };

            var response = await AuthenticationPort.RegisterAsync(registerRequest);
            
            if (response.IsSuccess && response.User != null)
            {
                var createdUser = await UserPort.GetByIdAsync(response.User.Id);
                if (createdUser != null)
                {
                    createdUser.Address = Address;
                    createdUser.City = City;
                    createdUser.Zip = Zip;
                    createdUser.Province = Province;
                    createdUser.CountryId = SelectedCountryId > 0 ? SelectedCountryId : (int)CountryEnum.USA;
                    await UserPort.UpdateAsync(createdUser);
                }
            }
            
            if (response.IsSuccess)
            {
                SuccessMessage = "Account created successfully! Redirecting to login...";
                await Task.Delay(2000);
                Navigation.NavigateTo("/login");
            }
            else
            {
                ErrorMessage = response.Message ?? "Registration failed. Please try again.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error creating account: {ex.Message}";
            Logger.LogError(ex, "Error creating account");
        }
    }
}
