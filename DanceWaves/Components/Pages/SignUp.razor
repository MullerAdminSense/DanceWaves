    
@using System.Security.Claims
@inject AuthenticationStateProvider AuthenticationStateProvider
@page "/signup"
@using DanceWaves.Application.Dtos
    
@using DanceWaves.Application.UseCases
@using DanceWaves.Application.Ports
@using DanceWaves.Models
@inject IAuthenticationPort AuthenticationPort
@inject NavigationManager Navigation
@inject ILogger<SignUp> Logger
@rendermode InteractiveServer

<div class="container-fluid mt-5">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0">üìã Sign Up</h3>
                            <p class="mb-0 small">Create your DanceWaves account</p>
                        </div>
                    </div>
                </div>

                <div class="card-body p-5">
                    @if (!string.IsNullOrEmpty(ErrorMessage))
                    {
                        <div class="alert alert-danger">@ErrorMessage</div>
                    }
                    @if (!string.IsNullOrEmpty(SuccessMessage))
                    {
                        <div class="alert alert-success">@SuccessMessage</div>
                    }
                    <form @onsubmit="HandleRegister">
                            
                            <div class="mb-3">
                                <label for="firstName" class="form-label">First Name *</label>
                                <input type="text" class="form-control" id="firstName" placeholder="Enter your first name" @bind="User.FirstName" required />
                            </div>
                            <div class="mb-3">
                                <label for="lastName" class="form-label">Last Name *</label>
                                <input type="text" class="form-control" id="lastName" placeholder="Enter your last name" @bind="User.LastName" required />
                            </div>
                            <div class="mb-3">
                                <label for="address" class="form-label">Address</label>
                                <input type="text" class="form-control" id="address" @bind="User.Address" />
                            </div>
                            <div class="mb-3">
                                <label for="city" class="form-label">City</label>
                                <input type="text" class="form-control" id="city" @bind="User.City" />
                            </div>
                            <div class="mb-3">
                                <label for="zip" class="form-label">Zip</label>
                                <input type="text" class="form-control" id="zip" @bind="User.Zip" />
                            </div>
                            <div class="mb-3">
                                <label for="province" class="form-label">Province</label>
                                <input type="text" class="form-control" id="province" @bind="User.Province" />
                            </div>
                            <div class="mb-3">
                                <label for="country" class="form-label">Country</label>
                                <select class="form-select" id="country" @bind="User.CountryId">
                                    <option value="">Select a country</option>
                                    @foreach (var country in Countries)
                                    {
                                        <option value="@country.Id">@country.Name</option>
                                    }
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">Email Address *</label>
                                <input type="email" class="form-control" id="email" placeholder="Enter your email" @bind="User.Email" required />
                            </div>
                            <div class="mb-3">
                                <label for="danceSchool" class="form-label">Dance School</label>
                                <select class="form-select" id="danceSchool" 
                                        value="@(User.DanceSchoolId?.ToString() ?? "")"
                                        @onchange="OnDanceSchoolChanged" 
                                        @onfocus="OnDanceSchoolFocus">
                                    <option value="">Select a dance school</option>
                                    @foreach (var school in DanceSchools)
                                    {
                                        <option value="@school.Id">@school.LegalName</option>
                                    }
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="phone" class="form-label">Phone Number</label>
                                <input type="text" class="form-control" id="phone" placeholder="Enter your phone number" @bind="User.Phone" />
                            </div>
                            <div class="mb-3">
                                <label for="franchise" class="form-label">Default Franchise</label>
                                <select class="form-select" id="franchise" 
                                        value="@(User.DefaultFranchiseId?.ToString() ?? "")"
                                        @onchange="OnFranchiseChanged"
                                        @onfocus="OnFranchiseFocus"
                                        disabled="@(User.DanceSchoolId == null)">
                                    <option value="">Select a franchise</option>
                                    @foreach (var franchise in FilteredFranchises)
                                    {
                                        <option value="@franchise.Id">@franchise.LegalName</option>
                                    }
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="ageGroup" class="form-label">Age Group</label>
                                <select class="form-select" id="ageGroup" 
                                        value="@(User.AgeGroupId?.ToString() ?? "")"
                                        @onchange="OnAgeGroupChanged"
                                        @onfocus="OnAgeGroupFocus">
                                    <option value="">Select an age group</option>
                                    @foreach (var ageGroup in AgeGroups)
                                    {
                                        <option value="@ageGroup.Id">@ageGroup.Name</option>
                                    }
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="rolePermission" class="form-label">Role Permission</label>
                                @if (IsAdmin && User.Id > 0)
                                {
                                    <select class="form-select" id="rolePermission" 
                                            value="@(User.RolePermissionId.ToString() ?? "")"
                                            @onchange="OnRolePermissionChanged">
                                        @foreach (var role in RolePermissions)
                                        {
                                            <option value="@role.Id">@role.Name</option>
                                        }
                                    </select>
                                }
                                else
                                {
                                    <input type="text" class="form-control" id="rolePermission" value="@RoleName" readonly disabled />
                                }
                            </div>
                            
                            <button type="submit" class="btn btn-primary btn-lg w-100" disabled="@IsLoading">
                                @(IsLoading ? (User.Id > 0 ? "Updating..." : "Creating...") : (User.Id > 0 ? "Update Account" : "Create Account"))
                            </button>
                            @if (User.Id == 0)
                            {
                                <div class="text-center mt-3">
                                    <p class="text-muted">Already have an account? <a href="/login">Sign In</a></p>
                                </div>
                            }
                        </form>
                    
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private UserDto User { get; set; } = new();
    private List<(int Id, string Name)> Countries { get; set; } = new();
    private List<DanceSchool> DanceSchools { get; set; } = new();
    private List<Franchise> FilteredFranchises { get; set; } = new();
    private List<AgeGroup> AgeGroups { get; set; } = new();
    private List<UserRolePermission> RolePermissions { get; set; } = new List<UserRolePermission>();
    private int? SelectedDanceSchoolId { get; set; }
    private int? SelectedFranchiseId { get; set; }
    private int? SelectedCountryId { get; set; }
    private int? SelectedAgeGroupId { get; set; }
    private bool _isLoadingFranchises = false;
    private bool _isLoadingDanceSchools = false;
    private bool _isLoadingAgeGroups = false;
    private bool IsAdmin { get; set; } = false;
    private string? ErrorMessage { get; set; }
    private string? SuccessMessage { get; set; }
    private bool IsLoading { get; set; }
    private bool ShowPassword { get; set; }
    private bool ShowConfirmPassword { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public string? userId { get; set; }
    [SupplyParameterFromQuery]
    public string? newUser { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            RolePermissions = await GetAllRolePermissionsAsync();
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userPrincipal = authState.User;
            string? currentUserId = userPrincipal.FindFirst(ClaimTypes.NameIdentifier)?.Value;
            if (!string.IsNullOrEmpty(currentUserId) && int.TryParse(currentUserId, out var currentId))
            {
                var currentUser = await AuthenticationPort.GetCurrentUserAsync(currentUserId);
                if (currentUser != null)
                {
                    var userRole = RolePermissions.FirstOrDefault(r => r.Id == currentUser.RolePermissionId);
                    IsAdmin = userRole != null && (userRole.Name == "SuperAdmin" || userRole.Name == "FranchiseAdmin");
                }
            }

            // Se √© admin e veio do bot√£o Add User, inicia cadastro em branco
            if (IsAdmin && !string.IsNullOrEmpty(newUser))
            {
                User = new UserDto();
                User.RolePermissionId = RolePermissions.FirstOrDefault(r => r.Name == "User")?.Id ?? 3;
            }
            // Se h√° um userId na query string, carrega esse usu√°rio (modo edi√ß√£o para admin)
            else if (!string.IsNullOrEmpty(userId) && int.TryParse(userId, out var editUserId))
            {
                // Apenas admins podem editar outros usu√°rios
                if (IsAdmin)
                {
                    var editUser = await AuthenticationPort.GetAllUsersAsync();
                    var userToEdit = editUser.FirstOrDefault(u => u.Id == editUserId);
                    if (userToEdit != null)
                    {
                        User = userToEdit;
                    }
                }
                else
                {
                    Navigation.NavigateTo("/administration/users");
                    return;
                }
            }
            else
            {
                // Caso contr√°rio, carrega o usu√°rio atual (modo normal)
                UserDto? loadedUser = null;
                if (!string.IsNullOrEmpty(currentUserId))
                {
                    loadedUser = await AuthenticationPort.GetCurrentUserAsync(currentUserId);
                }
                if (loadedUser != null)
                {
                    User = loadedUser;
                }
                else
                {
                    User = new UserDto();
                    User.RolePermissionId = RolePermissions.FirstOrDefault(r => r.Name == "User")?.Id ?? 3;
                }
            }

            Countries = new List<(int, string)>
            {
                ((int)CountryId.USA, "United States"),
                ((int)CountryId.Netherlands, "Netherlands"),
                ((int)CountryId.France, "France"),
                ((int)CountryId.Germany, "Germany")
            };

            await LoadDanceSchoolsFromDatabase();
            await LoadAgeGroupsFromDatabase();

            if (User.DanceSchoolId != null)
            {
                SelectedDanceSchoolId = User.DanceSchoolId;
                await LoadFranchisesForSelectedSchool();
            }
            if (User.CountryId != null)
            {
                SelectedCountryId = User.CountryId;
            }
            if (User.AgeGroupId != null)
            {
                SelectedAgeGroupId = User.AgeGroupId;
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading profile data: {ex.Message}";
            Logger.LogError(ex, "Error loading profile data in SignUp");
        }
    }
    
    private async Task<List<UserRolePermission>> GetAllRolePermissionsAsync()
    {
        return await AuthenticationPort.GetAllRolePermissionsAsync();
    }

    private async Task OnDanceSchoolFocus()
    {
        // Evita chamadas concorrentes
        if (_isLoadingDanceSchools) return;
        
        try
        {
            _isLoadingDanceSchools = true;
            // Recarrega DanceSchools do banco quando o combo √© focado (clicado)
            // Isso garante que mudan√ßas feitas por outros usu√°rios sejam refletidas
            await LoadDanceSchoolsFromDatabase();
            StateHasChanged();
        }
        finally
        {
            _isLoadingDanceSchools = false;
        }
    }

    private async Task OnFranchiseFocus()
    {
        // Evita chamadas concorrentes
        if (_isLoadingFranchises) return;
        
        // Recarrega as franchises do banco quando o combo √© focado (clicado)
        // Isso garante que mudan√ßas feitas por outros usu√°rios sejam refletidas
        if (User.DanceSchoolId != null)
        {
            SelectedDanceSchoolId = User.DanceSchoolId;
            await LoadFranchisesForSelectedSchool();
            StateHasChanged();
        }
    }

    private async Task OnAgeGroupFocus()
    {
        // Evita chamadas concorrentes
        if (_isLoadingAgeGroups) return;
        
        try
        {
            _isLoadingAgeGroups = true;
            // Recarrega AgeGroups do banco quando o combo √© focado (clicado)
            // Isso garante que mudan√ßas feitas por outros usu√°rios sejam refletidas
            await LoadAgeGroupsFromDatabase();
            StateHasChanged();
        }
        finally
        {
            _isLoadingAgeGroups = false;
        }
    }

    private async Task OnAgeGroupChanged(ChangeEventArgs e)
    {
        var newValue = e.Value?.ToString();
        int? newAgeGroupId = null;
        
        if (!string.IsNullOrEmpty(newValue) && int.TryParse(newValue, out var ageGroupId))
        {
            newAgeGroupId = ageGroupId;
        }
        
        User.AgeGroupId = newAgeGroupId;
        SelectedAgeGroupId = newAgeGroupId;
        StateHasChanged();
    }

    private async Task LoadDanceSchoolsFromDatabase()
    {
        // Sempre busca dados atualizados do banco
        DanceSchools = await AuthenticationPort.GetAllDanceSchoolsAsync();
    }

    private async Task LoadAgeGroupsFromDatabase()
    {
        // Sempre busca dados atualizados do banco
        AgeGroups = await AuthenticationPort.GetAllAgeGroupsAsync();
    }

    private async Task LoadFranchisesForSelectedSchool()
    {
        // Evita chamadas concorrentes
        if (_isLoadingFranchises) return;
        
        try
        {
            _isLoadingFranchises = true;
            
            int? schoolId = SelectedDanceSchoolId ?? User.DanceSchoolId;
            
            if (schoolId != null)
            {
                // Sempre busca dados atualizados do banco
                FilteredFranchises = await AuthenticationPort.GetFranchisesByDanceSchoolAsync(schoolId.Value);
            }
            else
            {
                FilteredFranchises = new List<Franchise>();
            }
        }
        finally
        {
            _isLoadingFranchises = false;
        }
        
        // Garante que a UI seja atualizada
        StateHasChanged();
    }

    private async Task OnDanceSchoolChanged(ChangeEventArgs e)
    {
        var newValue = e.Value?.ToString();
        int? newSchoolId = null;
        
        if (!string.IsNullOrEmpty(newValue) && int.TryParse(newValue, out var schoolId))
        {
            newSchoolId = schoolId;
        }
        
        SelectedDanceSchoolId = newSchoolId;
        User.DanceSchoolId = newSchoolId;
        
        // Reset franchise selection when dance school changes
        User.DefaultFranchiseId = null;
        
        // Recarrega as franchises do banco quando a dance school muda
        await LoadFranchisesForSelectedSchool();
        
        // For√ßa atualiza√ß√£o da UI
        StateHasChanged();
    }

    private async Task OnFranchiseChanged(ChangeEventArgs e)
    {
        var newValue = e.Value?.ToString();
        int? newFranchiseId = null;
        
        if (!string.IsNullOrEmpty(newValue) && int.TryParse(newValue, out var franchiseId))
        {
            newFranchiseId = franchiseId;
        }
        
        User.DefaultFranchiseId = newFranchiseId;
        StateHasChanged();
    }

    private async Task OnRolePermissionChanged(ChangeEventArgs e)
    {
        var newValue = e.Value?.ToString();
        int newRolePermissionId = 3; // Default: User
        
        if (!string.IsNullOrEmpty(newValue) && int.TryParse(newValue, out var roleId))
        {
            newRolePermissionId = roleId;
        }
        
        User.RolePermissionId = newRolePermissionId;
        StateHasChanged();
    }

    private string RoleName
    {
        get
        {
            if (User.RolePermissionId == 0)
                return string.Empty;
            var role = RolePermissions.FirstOrDefault(r => r.Id == User.RolePermissionId);
            if (role != null && !string.IsNullOrWhiteSpace(role.Name))
                return role.Name;
            
            role = RolePermissions.FirstOrDefault(r => r.Name?.Equals("User", StringComparison.OrdinalIgnoreCase) == true);
            if (role != null)
                return role.Name;
            return $"Role {User.RolePermissionId}";
        }
    }


    private async Task HandleRegister()
    {
        ErrorMessage = null;
        SuccessMessage = null;
        IsLoading = true;
        try
        {
            // Se √© admin editando outro usu√°rio, usa o ID do usu√°rio sendo editado
            string userIdToUpdate = User.Id.ToString();
            
            // Se est√° editando outro usu√°rio (modo admin), usa o ID do usu√°rio sendo editado
            if (IsAdmin && !string.IsNullOrEmpty(userId) && int.TryParse(userId, out var editUserId) && editUserId > 0)
            {
                userIdToUpdate = editUserId.ToString();
            }
            else
            {
                // Caso contr√°rio, usa o ID do usu√°rio atual
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var userPrincipal = authState.User;
                string? currentUserId = userPrincipal.FindFirst(ClaimTypes.NameIdentifier)?.Value;
                if (!string.IsNullOrEmpty(currentUserId))
                {
                    userIdToUpdate = currentUserId;
                }
            }
            
            var response = await AuthenticationPort.UpdateProfileAsync(userIdToUpdate, User);
            if (response.IsSuccess)
            {
                // Recarrega os dados do usu√°rio para refletir altera√ß√µes
                if (IsAdmin && User.Id > 0)
                {
                    // Se √© admin editando outro usu√°rio, recarrega da lista de usu√°rios
                    var allUsers = await AuthenticationPort.GetAllUsersAsync();
                    var updatedUser = allUsers.FirstOrDefault(u => u.Id == User.Id);
                    if (updatedUser != null)
                    {
                        User = updatedUser;
                    }
                }
                else
                {
                    // Caso contr√°rio, recarrega o usu√°rio atual
                    var updatedUser = await AuthenticationPort.GetCurrentUserAsync(userIdToUpdate);
                    if (updatedUser != null)
                    {
                        User = updatedUser;
                    }
                }
                SuccessMessage = "Profile updated successfully!";
                
                // Se √© admin editando outro usu√°rio, volta para a p√°gina de gerenciamento ap√≥s 2 segundos
                if (IsAdmin && !string.IsNullOrEmpty(userId))
                {
                    await Task.Delay(2000);
                    Navigation.NavigateTo("/administration/users");
                }
            }
            else
            {
                ErrorMessage = response.Message ?? "Profile update failed. Please try again.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"An error occurred: {ex.Message}";
            Logger.LogError(ex, "Error updating profile in SignUp");
        }
        finally
        {
            IsLoading = false;
        }
    }
}
